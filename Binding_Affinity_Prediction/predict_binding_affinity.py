"""
predict_binding_affinity.py

Uses the trained Random Forest model (aptamer_model.pkl) to predict the binding
affinity of a new aptamer sequence.

Requirements:
    • aptamer_model.pkl
    • dict_vectorizer.pkl

These files are generated by: RandomForest_Aptamer_Model.py
"""

import joblib
from collections import Counter
import numpy as np


def get_kmers(seq, k=2):
    seq = seq.replace("5'-", "").replace("-3'", "").replace(" ", "").upper()
    return [seq[i:i + k] for i in range(len(seq) - k + 1)]


def gc_content(seq):
    seq = seq.upper()
    if len(seq) == 0:
        return 0
    return (seq.count('G') + seq.count('C')) / len(seq)


def molecular_weight(seq):
    weights = {'A': 313.21, 'T': 304.2, 'G': 329.21, 'C': 289.18}
    return sum(weights.get(base, 0) for base in seq.upper())


def predict(sequence):
    model = joblib.load("aptamer_model.pkl")
    vectorizer = joblib.load("dict_vectorizer.pkl")

    kmers = get_kmers(sequence, k=2)
    kmer_counts = dict(Counter(kmers))
    kmer_vector = vectorizer.transform([kmer_counts])

    other_features = np.array([
        len(sequence),
        gc_content(sequence),
        molecular_weight(sequence)
    ]).reshape(1, -1)

    X = np.hstack([kmer_vector, other_features])
    predicted_affinity = model.predict(X)[0]
    return predicted_affinity


if __name__ == "__main__":
    input_sequence = "AGCTAGCTAGGCGTTA"
    result = predict(input_sequence)
    print(f"Predicted Binding Affinity: {result:.4f}")
